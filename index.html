<!DOCTYPE html>
<html>
<head>
    <title>WebRTC App</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Aplicação WebRTC</h1>
    <video id="localVideo" autoplay></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        
        let localStream;
        let peerConnection;
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // Captura da mídia local
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                // Inicializa a PeerConnection
                peerConnection = new RTCPeerConnection(config);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                // Envia candidatos ICE para o servidor de sinalização
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('signal', { 'ice': event.candidate });
                    }
                };

                // Recebe streams remotos
                peerConnection.ontrack = event => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };

                // Cria a oferta SDP
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        socket.emit('signal', { 'sdp': peerConnection.localDescription });
                    });
            })
            .catch(error => console.error('Erro ao acessar mídia:', error));

        // Recebe sinais do servidor de sinalização
        socket.on('signal', data => {
            if (data.sdp) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
                    .then(() => {
                        if (data.sdp.type === 'offer') {
                            peerConnection.createAnswer()
                                .then(answer => peerConnection.setLocalDescription(answer))
                                .then(() => {
                                    socket.emit('signal', { 'sdp': peerConnection.localDescription });
                                });
                        }
                    });
            } else if (data.ice) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.ice));
            }
        });
    </script>
</body>
</html>
